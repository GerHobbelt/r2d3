<!DOCTYPE html>
<html>
  <head>
    <title>Area Chart</title>
    <script type="text/javascript" src="../../d3.v2.min.js"></script>
    <style type="text/css">

    body {
      font: 10px sans-serif;
    }

    h1 {
      margin: 20px 20px 0;
      color: #888;
      font-weight: normal;
    }
  </style>
  </head>
  <body>
    <h1>Weight Trends</h1>
    <div id="container"></div>
    <script type="text/javascript">

var data = [
  { x: '01/01/2012', y: 173 },
  { x: '01/02/2012', y: 169 },
  { x: '01/03/2012', y: 175 },
  { x: '01/04/2012', y: 175 },
  { x: '01/06/2012', y: 173 },
  { x: '01/08/2012', y: 174 },
  { x: '01/14/2012', y: 176 },
  { x: '01/18/2012', y: 177 },
  { x: '01/20/2012', y: 180 },
  { x: '01/22/2012', y: 174 },
  { x: '01/23/2012', y: 172 },
  { x: '01/25/2012', y: 173 },
  { x: '01/26/2012', y: 175 },
  { x: '01/27/2012', y: 174 },
  { x: '01/28/2012', y: 177 },
  { x: '01/31/2012', y: 181 },
  { x: '08/09/2012', y: 190 }
]


function LineChart(el, data, options) {

  options = options || {};

  var w = options.width || el.offsetWidth - 40, // width
      h = options.height || 200, // height
      p = 20, //padding
      vis = Raphael(el, w + p * 2, h + p * 2),
      parse = d3.time.format("%m/%d/%Y").parse,
      format = d3.time.format("%m/%d"),
      x = d3.time.scale().domain([parse(data[0].x), parse(data[data.length-1].x)]).range([0, w]), //xscale
      ydomain = data.map(function(d) { return d.y; });
      y = d3.scale.linear().domain([d3.min(ydomain), d3.max(ydomain)]).range([h, 0]); // yscale


  // Styles
  var labelTickStyle = { font: '12px Helvetica, Arial', fill: "#000"},
      hoverValueTextStyle = { font: '12px Helvetica, Arial', fill: "#704026", 'font-weight': 'bold'},
      hoverDateTextStyle = { font: '10px Helvetica, Arial', fill: "#888"},
      markerOnStyle = { fill: '#f7d1e0', stroke: '#fa7ba6', 'stroke-width': '2px', 'fill-opacity': '1', r: 6 },
      markerOffStyle = { fill: '#95e0ff', stroke: '#66b7d5', 'stroke-width': '1.2px', 'fill-opacity': '1', r: 4};



  // Add everything created to a set, so I can offset by the padding when I'm done.
  vis.setStart();
  // Draw a border around the chart
  vis.rect(0, 0, w, h).attr({ stroke: '#eee',  fill: 'none', 'stroke-width': '1px' });
  vis.path('M0 ' + h + 'L' + w + ' ' + h).attr({stroke: '#66b7d5', 'stroke-width': 1}).toFront();

  // Vertical Ticks
  xticks = x.ticks(15).map(function(d, i) {
      return vis.path(['M', x(d), ' ', 0, 'L', x(d), ' ', h-1].join(''))
        .attr('stroke', '#e2eaed');
  });

  // Horizontal Ticks
  y.ticks(6).map(function(d) {
      return vis.path(['M', 0, ' ', y(d), 'L', w+1, ' ', y(d)].join(''))
        .attr('stroke', '#eef6f8');
  });

  // Data Line
  vis.path(d3.svg.line().x(function(d) { return x(parse(d.x)); }).y(function(d) { return y(d.y); })(data))
      .attr({ stroke: '#66b7d5',  fill: 'none', 'stroke-width': '2px' });

  // Data Area
  area = vis.path(d3.svg.area().x(function(d) { return x(parse(d.x)); }).y0(h-1).y1(function(d) { return y(d.y); })(data))
      .attr({ 'stroke': 'none',  fill: 'url(bg.png)', 'fill-opacity': .6 });

  // BG Images look like crap in VML
  if(!Raphael.svg) {
     area.attr('fill', '#f0f9f9')
  }

  /* Tick Labels */
  x.ticks(15).map(function(d) {
    vis.text(x(d), h + 12, format(d)).attr(labelTickStyle);
  });
  

  // Create the main label/popup to show on hovers
  var label = vis.set();
  label.push(vis.text(60, 12, "999lbs").attr(hoverValueTextStyle));
  label.push(vis.text(60, 27, "1/20/2012").attr(hoverDateTextStyle))
  label.hide();

  var popup = vis.popup(100, 100, label, "right")
    .attr({fill: "#fff", stroke: "#ddd", "stroke-width": 1.5, "fill-opacity": .95})
    .hide();

  var popupTimer,
      isPopupVisible = false,
      blankets = vis.set();

  // Markers
  data.forEach(function(d, i, a) {
    var onStyle = { fill: '#f7d1e0', stroke: '#fa7ba6', 'stroke-width': '2px', 'fill-opacity': '1', r: 6 },
        offStyle = { fill: '#95e0ff', stroke: '#66b7d5', 'stroke-width': '1.2px', 'fill-opacity': '1', r: 4},
        dx = x(parse(d.x)),
        dy = y(d.y);

    // Vertical line over X axis 
    var lineMarker = vis.path(['M', dx, ' ', 0, 'L', dx, , ' ', h-1].join(''))
          .attr({  stroke: '#c1afa5', 'stroke-width': 2, 'stroke-opacity': 0.8, 'stroke-opacity': 0 })

    // Circle for data point
    var marker = vis.circle(dx, dy, 4).attr(offStyle);

    // For each marker, create a rectangle "blanket" over each area to highlight its associated marker on hover
    var x0 = i === 0 ? dx : (dx + x(parse(a[i-1].x)))/2,
        x1 = i === a.length - 1 ? dx : (dx + x(parse(a[i+1].x)))/2;

    var blanket = vis.rect(x0, 0, x1 - x0, h).attr({stroke: 'none', fill: '#fff', 'fill-opacity': 0 })
      .hover(function() {
        marker.attr(markerOnStyle);
        lineMarker.attr('stroke-opacity', .8);
        clearTimeout(popupTimer);
        var side = "right";
        if (dx + popup.getBBox().width > w) {
          side = "left";
        }

        // Build a new popup for this point, and only return its position context,
        // to determine where to animate the main popup to
        var ppp = vis.popup(dx + p, dy + p, label, side, 1),
            anim = Raphael.animation({ path: ppp.path, transform: ["t", ppp.dx, ppp.dy]}, 200 * isPopupVisible);
        lx = label[0].transform()[0][1] + ppp.dx;
        ly = label[0].transform()[0][2] + ppp.dy;
        popup.show().stop().animate(anim);
        label[0].attr({text: d.y + "lbs"}).show().stop().animateWith(popup, anim, {transform: ["t", lx, ly]}, 200 * isPopupVisible);
        label[1].attr({text: d.x}).show().stop().animateWith(popup, anim, {transform: ["t", lx, ly]}, 200 * isPopupVisible);
        isPopupVisible = true;
      }, function() {
        lineMarker.attr('stroke-opacity', 0);
        marker.attr(markerOffStyle);
        popupTimer = setTimeout(function () {
          popup.hide();
          label[0].hide();
          label[1].hide();
          isPopupVisible = false;
        }, 1);
    }).toFront();
    blankets.push(blanket);
  });


  // Ensure the popup is the topmost thing, just under the blankets
  popup.toFront();
  label.toFront();
  blankets.toFront();


  vis.setFinish().transform(['t', p, p]);
};

  LineChart(document.getElementById('container'), data);
      </script>
    </body>
  </html>
